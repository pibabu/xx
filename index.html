<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Terminal Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            colors: {
              terminal: {
                bg: '#000000',
                text: '#ffffff',
                prompt: '#4ade80',
                input: '#facc15',
                error: '#ef4444',
                success: '#10b981'
              }
            }
          }
        }
      }
    </script>
</head>
<body class="bg-terminal-bg text-terminal-text font-mono h-screen overflow-hidden">
  <div class="container mx-auto h-full flex flex-col">
    <!-- Status bar -->
    <div class="px-2 py-1 border-b border-gray-800 flex items-center justify-between text-sm">
      <div class="flex items-center space-x-2">
        <div id="status-indicator" class="w-2 h-2 rounded-full bg-terminal-error"></div>
        <span id="status-text" class="text-xs text-gray-500">Disconnected</span>
      </div>
      <button id="reconnect-btn" class="text-xs text-terminal-prompt hover:underline hidden" onclick="connectWebSocket()">
        Reconnect
      </button>
    </div>
    <!-- Chat history container -->
    <div id="chat-history" class="flex-1 overflow-y-auto p-4 space-y-4 scrollbar-hide">
      <div class="text-gray-500 text-sm">
        <span class="text-terminal-prompt">System:</span> Terminal chat initialized. Waiting for connection...
      </div>
    </div>
    
    <!-- Input area -->
    <div class="p-4 border-t border-gray-800">
      <div class="flex items-center">
        <span class="text-terminal-prompt mr-2">></span>
        <input
          id="user-input" 
          type="text" 
          class="bg-transparent flex-1 text-terminal-input outline-none caret-terminal-prompt" 
          autofocus 
          placeholder="_"
          onkeydown="handleInputKey(event)"
        >
      </div>
    </div>
  </div>
  <style>
    .scrollbar-hide::-webkit-scrollbar {
      width: 3px;
    }
    .scrollbar-hide::-webkit-scrollbar-thumb {
      background: rgba(74, 222, 128, 0.2);
      border-radius: 10px;
    }
    .scrollbar-hide::-webkit-scrollbar-thumb:hover {
      background: rgba(74, 222, 128, 0.3);
    }
    .scrollbar-hide::-webkit-scrollbar-track {
      background: transparent;
    }
    /* Firefox scrollbar */
    .scrollbar-hide {
      scrollbar-width: thin;
      scrollbar-color: rgba(74, 222, 128, 0.2) transparent;
    }
  </style>

  <script>
    let ws = null;
    let currentAiMessage = null;

    const WS_URL = `ws://${window.location.host}/ws`;

    // Update connection status UI
    function updateStatus(connected) {
      const indicator = document.getElementById('status-indicator');
      const statusText = document.getElementById('status-text');
      const reconnectBtn = document.getElementById('reconnect-btn');
      const input = document.getElementById('user-input');

      if (connected) {
        indicator.className = 'w-2 h-2 rounded-full bg-terminal-success';
        statusText.textContent = 'Connected';
        reconnectBtn.classList.add('hidden');
        input.disabled = false;
        input.placeholder = '_';
      } else {
        indicator.className = 'w-2 h-2 rounded-full bg-terminal-error';
        statusText.textContent = 'Disconnected';
        reconnectBtn.classList.remove('hidden');
        input.disabled = true;
        input.placeholder = 'Disconnected...';
      }
    }

    // Append message to chat history
    function appendMessage(role, content, messageId = null) {
  const chatHistory = document.getElementById('chat-history');
  
  if (messageId && document.getElementById(messageId)) {
    // Update existing message
    const existingMsg = document.getElementById(messageId);
    existingMsg.querySelector('.message-content').textContent = content;
  } else {
    // Create new message
    const messageDiv = document.createElement('div');
    messageDiv.id = messageId || `msg-${Date.now()}`;
    
    if (role === 'user') {
      messageDiv.innerHTML = `
        <div class="flex items-start space-x-2">
          <span class="text-terminal-prompt">You:</span>
          <span class="message-content text-terminal-input">${escapeHtml(content)}</span>
        </div>
      `;
    } else if (role === 'ai') {
      messageDiv.innerHTML = `
        <div class="flex items-start space-x-2">
          <span class="text-terminal-prompt">AI:</span>
          <span class="message-content text-gray-300">${escapeHtml(content)}</span>
        </div>
      `;
    } else if (role === 'tool') {
      // ðŸ‘ˆ ADD THIS NEW BLOCK HERE
      messageDiv.innerHTML = `
        <div class="flex items-start space-x-2">
          <span class="text-yellow-500">ðŸ”§</span>
          <span class="message-content text-yellow-400">${escapeHtml(content)}</span>
        </div>
      `;
    } else {
      // System messages (existing else block stays)
      messageDiv.innerHTML = `
        <div class="text-gray-500 text-sm">
          <span class="text-terminal-prompt">System:</span>
          <span class="message-content">${escapeHtml(content)}</span>
        </div>
      `;
    }
    
    chatHistory.appendChild(messageDiv);
  }
  
  chatHistory.scrollTop = chatHistory.scrollHeight;
}

    // Escape HTML to prevent XSS
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Connect to WebSocket server
    function connectWebSocket() {
      if (ws && (ws.readyState === WebSocket.CONNECTING || ws.readyState === WebSocket.OPEN)) {
        return;
      }

      appendMessage('system', 'Connecting to server...');
      
      // Show progress messages while waiting
      const timeout1 = setTimeout(() => {
        if (!ws || ws.readyState !== WebSocket.OPEN) {
          appendMessage('system', 'Dauert noch... Docker fÃ¤hrt hoch...');
        }
      }, 2000);
      
      const timeout2 = setTimeout(() => {
        if (!ws || ws.readyState !== WebSocket.OPEN) {
          appendMessage('system', 'Hol dir noch nen Kaffee...');
        }
      }, 7000);
      
      ws = new WebSocket(WS_URL);

      ws.onopen = () => {
        clearTimeout(timeout1);
        clearTimeout(timeout2);
        appendMessage('system', 'Connected to chat server');
        updateStatus(true);
      };

      ws.onmessage = function(event) {
  const data = JSON.parse(event.data);
  
   if (data.type === 'start') {
      // Start new AI message
      currentMessageId = `msg-${Date.now()}`;
      appendMessage('ai', '', currentMessageId);
    } 
    else if (data.type === 'token') {
      // Append token to existing message
      const existingMsg = document.getElementById(currentMessageId);
      const contentSpan = existingMsg.querySelector('.message-content');
      contentSpan.textContent += data.content;
    }
    else if (data.type === 'tool_start') {
      // ðŸ‘ˆ ADD THIS
      appendMessage('tool', `Using tool: ${data.tool}...`);
   }
   else if (data.type === 'tool_result') {
      // ðŸ‘ˆ ADD THIS
      appendMessage('tool', data.content);
    }
    else if (data.type === 'end') {
     currentMessageId = null;
    }
    else if (data.type === 'error') {
      appendMessage('system', `Error: ${data.message}`);
    }
  };

      ws.onerror = (error) => {
        appendMessage('system', 'Connection error occurred');
        console.error('WebSocket error:', error);
      };

      ws.onclose = () => {
        appendMessage('system', 'Connection closed');
        updateStatus(false);
        currentAiMessage = null;
      };
    }

    // Send message via WebSocket
    function sendMessage() {
      const input = document.getElementById('user-input');
      const message = input.value.trim();
      
      if (!message) return;
      
      if (!ws || ws.readyState !== WebSocket.OPEN) {
        appendMessage('system', 'Not connected. Click Reconnect to try again.');
        return;
      }
      
      appendMessage('user', message);
      ws.send(JSON.stringify({ message }));
      input.value = '';
    }

    // Handle input key events
    function handleInputKey(event) {
      if (event.key === 'Enter') {
        sendMessage();
      }
    }

    // Auto-connect and focus input on page load
    window.addEventListener('load', () => {
      const input = document.getElementById('user-input');
      input.disabled = false;
      input.focus();
      connectWebSocket();
    });

    // Reconnect and focus input on window focus if disconnected
    window.addEventListener('focus', () => {
      if (!ws || ws.readyState === WebSocket.CLOSED) {
        connectWebSocket();
      }
      const input = document.getElementById('user-input');
      input.focus();
    });

    // Enable input when typing
    document.addEventListener('keydown', (e) => {
      const input = document.getElementById('user-input');
      if (document.activeElement !== input && e.key.length === 1) {
        input.focus();
      }
    });
  </script>
</body>
</html>