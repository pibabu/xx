#!/bin/bash


sudo yum update -y
sudo yum install -y python3 python3-pip python3-devel gcc


#sudo yum install -y docker
#sudo systemctl start docker
#sudo systemctl enable docker
#sudo usermod -a -G docker ec2-user

#sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
#sudo chmod +x /usr/local/bin/docker-compose

#sudo yum install -y nginx
# Start Nginx
#sudo systemctl start nginx
# Enable Nginx to start on boot
#sudo systemctl enable nginx


# Create application directory
sudo mkdir -p /home/ec2-user/fastapi-app
sudo chown ec2-user:ec2-user /home/ec2-user/fastapi-app

# Pre-create the venv and install common dependencies
sudo -u ec2-user python3 -m venv /home/ec2-user/fastapi-app/venv
sudo -u ec2-user /home/ec2-user/fastapi-app/venv/bin/pip install --upgrade pip
sudo -u ec2-user /home/ec2-user/fastapi-app/venv/bin/pip install \
    fastapi \
    uvicorn[standard] \
    websockets \
    openai \
    pydantic \
    python-dotenv

# Configure firewall (if firewalld is running)
if systemctl is-active --quiet firewalld; then
    sudo firewall-cmd --permanent --add-service=http
    sudo firewall-cmd --permanent --add-service=https
    sudo firewall-cmd --reload
fi
