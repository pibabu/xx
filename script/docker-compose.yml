services:
  {{CONTAINER_NAME}}:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: "{{CONTAINER_NAME}}"
    hostname: "{{CONTAINER_NAME}}"
    
    # Start in private data directory
    working_dir: /app/private
    
    # Volume mounts - shared is now read-write
    volumes:
      - "{{PRIVATE_VOLUME}}:/app/private"
      - shared_data:/app/shared:rw
    
    restart: unless-stopped
    
    # Environment variables available inside container
    environment:
      - CONTAINER_NAME={{CONTAINER_NAME}}
      - TAGS={{TAGS}}
      - PRIVATE_DATA_PATH=/app/private
      - SHARED_DATA_PATH=/app/shared
    
    # Labels for container metadata
    labels:
      - "user.name={{CONTAINER_NAME}}"
      - "user.tags={{TAGS}}"
    
    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 128M
    
    networks:
      - user_network
    
    # Health check
    healthcheck:
      test: ["CMD-SHELL", "test -d /app/private && test -d /app/shared"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s

networks:
  user_network:
    external: true
    name: user_shared_network

volumes:
  {{PRIVATE_VOLUME}}:
    external: true
  
  shared_data:
    external: true