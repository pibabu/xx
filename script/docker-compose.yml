services:
  {{CONTAINER_NAME}}:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: "{{CONTAINER_NAME}}"
    hostname: "{{CONTAINER_NAME}}"
    
    working_dir: /llm/private
    
    volumes:
      - "{{PRIVATE_VOLUME}}:/llm/private"
      - shared_data:/llm/shared:rw
    
    restart: unless-stopped
    
    environment:
      - CONTAINER_NAME={{CONTAINER_NAME}}
      - TAGS={{TAGS}}
      - PRIVATE_DATA_PATH=/llm/private
      - SHARED_DATA_PATH=/llm/shared
      - API_HOST=host.docker.internal
      - API_PORT=8000
      - USER_HASH=${USER_HASH}
      - API_BASE:-http://localhost:8000
    
    labels:
      - "user.name={{CONTAINER_NAME}}"
      - "user.tags={{TAGS}}"
      - "user_hash={{USER_HASH}}"
    
    networks:
      - user_shared_network

    extra_hosts:
      - "host.docker.internal:host-gateway"
    
    healthcheck:
      test: ["CMD-SHELL", "test -d /llm/private && test -d /llm/shared"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s

networks:
  user_shared_network:
    external: true

volumes:
  {{PRIVATE_VOLUME}}:
    external: true
  
  shared_data:
    external: true
